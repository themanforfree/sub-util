# 实现计划

- [x] 1. 扩展配置结构以支持新功能
  - 在 AppConfig 中添加 region_groups、default_config、provider_config 字段
  - 创建 RegionGroupConfig、RegionTemplate、DefaultConfig、ProviderConfig 结构体
  - 更新配置文件解析逻辑以支持新的配置选项
  - _需求: 2.1, 6.1, 6.2, 6.3, 6.4_

- [x] 2. 实现代理组模板生成器
- [x] 2.1 创建 ProxyGroupTemplateGenerator 结构体和基础方法
  - 实现 generate_region_groups 方法生成地区代理组
  - 实现 create_region_select_group 和 create_region_auto_group 方法
  - 实现 merge_with_user_groups 方法合并用户自定义代理组
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 2.2 实现默认地区模板系统
  - 创建 get_default_region_templates 函数提供内置地区模板
  - 支持常见地区的过滤器模式（HK、US、JP、SG、TW、KR）
  - 实现自定义地区模板的加载和合并逻辑
  - _需求: 7.1, 7.2, 7.3_

- [x] 2.3 实现代理组过滤器配置
  - 为地区代理组正确设置 filter 字段
  - 确保过滤器使用正确的正则表达式语法
  - 实现代理组的 use 字段配置以引用所有 provider
  - _需求: 2.1, 2.4_

- [x] 3. 增强 proxy provider 生成逻辑
- [x] 3.1 更新 generate_proxy_providers 函数
  - 支持从 ProviderConfig 读取健康检查配置
  - 支持自定义健康检查 URL 和间隔设置
  - 支持配置更新间隔和延迟加载选项
  - _需求: 1.2, 5.1, 5.2, 5.3_

- [x] 3.2 实现 provider 配置的默认值处理
  - 为健康检查设置合理的默认值
  - 为更新间隔设置默认值（3600秒）
  - 为本地缓存路径设置默认值
  - _需求: 1.3, 5.4_

- [x] 4. 更新主配置生成逻辑
- [x] 4.1 修改 generate_clash_config 函数
  - 集成 ProxyGroupTemplateGenerator 到配置生成流程
  - 实现默认配置的应用逻辑
  - 确保地区代理组和用户代理组正确合并
  - _需求: 2.2, 6.1, 6.2, 6.3, 6.4_

- [x] 4.2 实现配置验证和错误处理
  - 验证生成的代理组配置的有效性
  - 实现配置冲突检测和处理
  - 添加详细的错误信息和日志记录
  - _需求: 8.1, 8.2, 8.3, 8.4_

- [x] 5. 增强规则配置支持
- [x] 5.1 支持规则中引用地区代理组
  - 确保规则可以正确引用生成的地区代理组
  - 验证规则目标的有效性
  - 支持规则集指定特定地区或代理组
  - _需求: 3.1, 3.2, 3.4_

- [x] 5.2 保持规则集的自动更新功能
  - 确保规则集的更新间隔配置正确
  - 维护规则集的本地缓存路径设置
  - 保持现有的规则处理逻辑
  - _需求: 3.3_

- [x] 6. 更新 HTTP API 以支持新功能
- [x] 6.1 增强 API 响应以包含完整配置
  - 确保生成的配置包含所有必要字段
  - 验证 YAML 序列化的正确性
  - 保持与现有 API 的兼容性
  - _需求: 4.1, 4.3_

- [x] 6.2 改进 API 错误处理
  - 为配置生成失败提供有意义的错误信息
  - 实现更好的错误响应格式
  - 添加配置验证失败的详细信息
  - _需求: 4.4, 8.3_

- [x] 7. 添加配置文件示例和文档
- [x] 7.1 创建完整的配置文件示例
  - 提供包含所有新功能的 config.toml 示例
  - 展示地区代理组配置的最佳实践
  - 包含常见使用场景的配置示例
  - _需求: 2.1, 2.2, 3.1, 6.1_

- [x] 7.2 更新现有配置文件
  - 更新项目中的 config.toml 以使用新功能
  - 确保向后兼容性
  - 添加必要的配置注释和说明
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [x] 8. 编写单元测试
- [x] 8.1 为 ProxyGroupTemplateGenerator 编写测试
  - 测试地区代理组生成逻辑
  - 测试过滤器配置的正确性
  - 测试代理组合并功能
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 8.2 为配置生成逻辑编写测试
  - 测试完整的配置生成流程
  - 测试默认值应用逻辑
  - 测试错误处理和边界情况
  - _需求: 4.1, 4.3, 8.1, 8.4_

- [x] 8.3 为新配置结构编写测试
  - 测试 TOML 配置文件解析
  - 测试配置验证逻辑
  - 测试配置结构的序列化和反序列化
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [x] 9. 集成测试和验证
- [x] 9.1 端到端配置生成测试
  - 使用真实配置文件测试完整流程
  - 验证生成的 YAML 配置的有效性
  - 测试 HTTP API 的完整响应
  - _需求: 4.1, 4.2, 4.3, 4.4_

- [x] 9.2 配置兼容性验证
  - 验证生成的配置符合 Clash 规范
  - 测试过滤器在实际环境中的工作情况
  - 确保与不同版本 Clash 客户端的兼容性
  - _需求: 1.1, 2.1, 5.1, 5.4_