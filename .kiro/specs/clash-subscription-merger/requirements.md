# 需求文档

## 介绍

这个功能旨在完善现有的 Clash 订阅合并工具，使其能够更好地处理多个订阅源的合并、代理组的自动管理、规则的灵活配置，以及提供更完整的订阅服务功能。当前项目已经有了基础框架，需要在此基础上增强功能的完整性和易用性。

## 需求

### 需求 1

**用户故事：** 作为一个 Clash 用户，我希望能够配置多个订阅源作为 proxy provider，这样我就可以统一管理来自不同提供商的代理节点，让 Clash 客户端自己解析具体的节点信息。

#### 验收标准

1. WHEN 用户在配置文件中添加多个订阅 URL THEN 系统应该将它们配置为 proxy provider
2. WHEN 配置 proxy provider 时 THEN 系统应该设置适当的健康检查和更新间隔
3. WHEN 订阅源配置时 THEN 系统应该为每个 provider 设置本地缓存路径
4. WHEN 生成最终配置时 THEN 所有 proxy provider 应该被正确引用到代理组中

### 需求 2

**用户故事：** 作为一个用户，我希望系统能够按地区自动分组代理节点，这样我就可以为不同的规则集指定特定地区的代理，而不需要指定具体的节点。

#### 验收标准

1. WHEN 系统生成代理组时 THEN 应该能够根据节点名称自动识别地区信息
2. WHEN 创建地区代理组时 THEN 应该为每个识别的地区创建对应的选择组和自动测试组
3. WHEN 配置代理组时 THEN 应该支持在代理组中引用多个 proxy provider
4. WHEN 生成地区组时 THEN 应该使用过滤器从 provider 中筛选特定地区的节点

### 需求 3

**用户故事：** 作为一个用户，我希望能够为规则和规则集指定特定的代理组或地区，这样我就可以根据不同的网站和服务选择合适的代理策略和地区。

#### 验收标准

1. WHEN 用户配置单个规则时 THEN 系统应该支持指定具体的代理组或地区组作为目标
2. WHEN 用户配置规则集时 THEN 系统应该支持为规则集指定特定的代理组或地区组
3. WHEN 规则集更新时 THEN 系统应该支持定期自动更新并保持代理组配置
4. WHEN 配置规则目标时 THEN 系统应该支持引用地区代理组（如 "US"、"HK"、"JP" 等）

### 需求 4

**用户故事：** 作为一个用户，我希望通过 HTTP API 获取合并后的配置，这样我就可以在 Clash 客户端中使用这个订阅地址。

#### 验收标准

1. WHEN 用户访问订阅 API 时 THEN 系统应该返回完整的 Clash 配置文件
2. WHEN 用户提供 URL 参数时 THEN 系统应该能够动态替换特定的订阅源
3. WHEN 生成配置时 THEN 应该包含所有必要的字段（代理、代理组、规则等）
4. WHEN 配置生成失败时 THEN 系统应该返回有意义的错误信息

### 需求 5

**用户故事：** 作为一个用户，我希望系统能够为 proxy provider 配置健康检查，这样 Clash 客户端就可以自动测试和管理代理节点的可用性。

#### 验收标准

1. WHEN 配置 proxy provider 时 THEN 系统应该设置健康检查参数
2. WHEN 配置健康检查时 THEN 系统应该支持自定义检查 URL 和间隔
3. WHEN 设置健康检查时 THEN 系统应该支持延迟加载（lazy）选项
4. WHEN 生成配置时 THEN 所有 proxy provider 应该包含一致的健康检查设置

### 需求 6

**用户故事：** 作为一个用户，我希望能够自定义配置模板和默认设置，这样我就可以根据自己的使用习惯调整生成的配置。

#### 验收标准

1. WHEN 用户需要自定义端口设置时 THEN 系统应该支持配置 HTTP、SOCKS5、混合端口等
2. WHEN 用户需要设置日志级别时 THEN 系统应该支持不同的日志级别配置
3. WHEN 用户需要自定义 DNS 设置时 THEN 系统应该支持 DNS 配置选项
4. WHEN 用户需要设置运行模式时 THEN 系统应该支持 rule、global、direct 模式

### 需求 7

**用户故事：** 作为一个用户，我希望系统能够智能识别代理节点的地区信息，这样我就可以使用地区代理组来管理不同地区的节点。

#### 验收标准

1. WHEN 系统处理代理节点时 THEN 应该能够从节点名称中提取地区信息
2. WHEN 识别地区时 THEN 系统应该支持常见的地区标识（如 HK、US、JP、SG 等）
3. WHEN 创建地区组时 THEN 系统应该为每个地区创建选择组和自动测试组
4. WHEN 地区无法识别时 THEN 系统应该将节点归类到默认组中

### 需求 8

**用户故事：** 作为一个开发者，我希望系统具有良好的错误处理和日志记录，这样我就可以快速诊断和解决问题。

#### 验收标准

1. WHEN 系统遇到错误时 THEN 应该记录详细的错误信息和堆栈跟踪
2. WHEN 处理订阅源时 THEN 应该记录获取和解析的状态信息
3. WHEN 配置验证失败时 THEN 系统应该提供具体的验证错误信息
4. WHEN 系统运行时 THEN 应该提供不同级别的日志输出以便调试